#!/usr/bin/env python3
"""ivco-xsearch â€” Search X (Twitter) via official API v2.

Replaces bird CLI dependency with direct X API v2 calls.
Output: JSON array in bird-compatible format for downstream ivco-filter/ivco-collect.
Auth: X_BEARER_TOKEN from ~/.config/env/global.env

Usage:
  ivco-xsearch "paypal" -n 10
  ivco-xsearch "\$PYPL earnings" -n 5
  ivco-xsearch "paypal OR PYPL" -n 20 --include-retweets

Cost: ~$0.005 per tweet read (24h dedup). 10 tweets = $0.05.
"""

import argparse
import json
import os
import ssl
import sys
import urllib.parse
import urllib.request
import urllib.error

try:
    import certifi
    SSL_CONTEXT = ssl.create_default_context(cafile=certifi.where())
except ImportError:
    SSL_CONTEXT = ssl.create_default_context()

API_URL = "https://api.x.com/2/tweets/search/recent"
ENV_FILE = os.path.expanduser("~/.config/env/global.env")


def load_bearer_token() -> str | None:
    """Load X_BEARER_TOKEN from env var or env file."""
    token = os.environ.get("X_BEARER_TOKEN")
    if token:
        return token
    if os.path.exists(ENV_FILE):
        with open(ENV_FILE) as f:
            for line in f:
                line = line.strip()
                if line.startswith("X_BEARER_TOKEN="):
                    return line.split("=", 1)[1]
    return None


def search_recent(query: str, max_results: int, token: str, no_retweets: bool = True) -> dict:
    """Call X API v2 tweets/search/recent endpoint."""
    q = f"{query} -is:retweet" if no_retweets else query

    params = {
        "query": q,
        "max_results": max(10, min(max_results, 100)),
        "tweet.fields": "created_at,public_metrics,author_id,conversation_id,entities",
        "expansions": "author_id",
        "user.fields": "username,name,public_metrics",
        "sort_order": "relevancy",
    }

    qs = "&".join(
        f"{k}={urllib.parse.quote(str(v))}" for k, v in params.items()
    )
    url = f"{API_URL}?{qs}"

    req = urllib.request.Request(
        url,
        headers={
            "Authorization": f"Bearer {token}",
            "User-Agent": "ivco-xsearch/1.0",
        },
    )

    resp = urllib.request.urlopen(req, timeout=15, context=SSL_CONTEXT)
    return json.loads(resp.read().decode())


def to_bird_format(api_response: dict) -> list[dict]:
    """Transform X API v2 response to bird-compatible JSON array.

    Bird format: [{"id", "text", "createdAt", "author": {"username", "name"}}]
    X API v2 format: {"data": [...], "includes": {"users": [...]}}
    """
    data = api_response.get("data", [])
    users_by_id = {
        u["id"]: u for u in api_response.get("includes", {}).get("users", [])
    }

    results = []
    for tweet in data:
        author_id = tweet.get("author_id", "")
        user = users_by_id.get(author_id, {})

        results.append({
            "id": tweet["id"],
            "text": tweet.get("text", ""),
            "createdAt": tweet.get("created_at", ""),
            "author": {
                "username": user.get("username", "unknown"),
                "name": user.get("name", "unknown"),
            },
            "public_metrics": tweet.get("public_metrics", {}),
        })

    return results


def main():
    parser = argparse.ArgumentParser(
        prog="ivco-xsearch",
        description="Search X via official API v2. Output: bird-compatible JSON.",
    )
    parser.add_argument("query", help="Search query (supports X operators: OR, -, $TICKER, from:, etc.)")
    parser.add_argument("-n", "--max-results", type=int, default=10,
                        help="Max tweets to return (10-100, default: 10)")
    parser.add_argument("--include-retweets", action="store_true",
                        help="Include retweets (excluded by default)")
    parser.add_argument("--raw", action="store_true",
                        help="Output raw X API v2 response instead of bird format")
    args = parser.parse_args()

    token = load_bearer_token()
    if not token:
        print("ERROR: X_BEARER_TOKEN not found in env or ~/.config/env/global.env",
              file=sys.stderr)
        sys.exit(1)

    try:
        response = search_recent(
            args.query,
            args.max_results,
            token,
            no_retweets=not args.include_retweets,
        )

        if args.raw:
            print(json.dumps(response, ensure_ascii=False, indent=2))
        else:
            results = to_bird_format(response)
            print(json.dumps(results, ensure_ascii=False, indent=2))

        count = response.get("meta", {}).get("result_count", 0)
        print(f"ivco-xsearch: {count} tweets found", file=sys.stderr)

    except urllib.error.HTTPError as e:
        body = e.read().decode()[:200] if e.fp else ""
        print(f"ERROR: HTTP {e.code}: {body}", file=sys.stderr)
        print("[]")
    except urllib.error.URLError as e:
        print(f"ERROR: Connection failed: {e.reason}", file=sys.stderr)
        print("[]")
    except Exception as e:
        print(f"ERROR: {e}", file=sys.stderr)
        print("[]")


if __name__ == "__main__":
    main()
